{% extends "base.html" %}

{% block title %}Blood Reports{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Blood Reports</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReportModal">
            <i class="fas fa-plus"></i> New Report
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchReports" placeholder="Search reports...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="dateFilter">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Blood Reports</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="reportsTable">
                    <thead>
                        <tr>
                            <th>Report ID</th>
                            <th>Test Date</th>
                            <th>Patient Name</th>
                            <th>Phone</th>
                            <th>Doctor</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Report Modal -->
<div class="modal fade" id="addReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Blood Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addReportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientSelect" class="form-label">Patient *</label>
                                <select class="form-select" id="patientSelect" name="patient_id" required>
                                    <option value="">Select Patient</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="testDate" class="form-label">Test Date *</label>
                                <input type="date" class="form-control" id="testDate" name="test_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="doctorName" class="form-label">Doctor Name</label>
                                <input type="text" class="form-control" id="doctorName" name="doctor_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="labTechnician" class="form-label">Lab Technician</label>
                                <input type="text" class="form-control" id="labTechnician" name="lab_technician">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <!-- Test Selection -->
                    <h6 class="mb-3">Select Tests</h6>
                    <div id="testSelection" class="mb-3">
                        <!-- Test checkboxes will be loaded here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveReport()">Create Report</button>
            </div>
        </div>
    </div>
</div>

<!-- View Report Modal -->
<div class="modal fade" id="viewReportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportDetails">
                <!-- Report details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="downloadReportPDF()">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button type="button" class="btn btn-primary" onclick="addTestResults()">
                    <i class="fas fa-plus"></i> Add Results
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Test Results Modal -->
<div class="modal fade" id="addResultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addResultsForm">
                    <div id="testResultsForm">
                        <!-- Test result forms will be generated here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTestResults()">Save Results</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentReportId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadReports();
    loadPatients();
    loadTestTypes();
    
    // Set today's date as default
    document.getElementById('testDate').value = new Date().toISOString().split('T')[0];
    
    // Setup search and filters
    document.getElementById('searchReports').addEventListener('input', filterReports);
    document.getElementById('statusFilter').addEventListener('change', filterReports);
    document.getElementById('dateFilter').addEventListener('change', filterReports);
});

function loadReports() {
    showLoading();
    fetch('/api/reports')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                populateReportsTable(data.data);
            } else {
                showToast('Error loading reports: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Error loading reports', 'error');
        });
}

function loadPatients() {
    fetch('/api/patients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('patientSelect');
                select.innerHTML = '<option value="">Select Patient</option>';
                data.data.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.patient_id;
                    option.textContent = `${patient.first_name} ${patient.last_name} - ${patient.phone_number}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading patients:', error));
}

function loadTestTypes() {
    fetch('/api/tests')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('testSelection');
                container.innerHTML = '';
                data.data.forEach(test => {
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${test.test_type_id}" id="test_${test.test_type_id}">
                        <label class="form-check-label" for="test_${test.test_type_id}">
                            ${test.test_name} (${test.test_code}) - â‚¹${test.price}
                        </label>
                    `;
                    container.appendChild(div);
                });
            }
        })
        .catch(error => console.error('Error loading test types:', error));
}

function populateReportsTable(reports) {
    const tbody = document.querySelector('#reportsTable tbody');
    tbody.innerHTML = '';
    
    reports.forEach(report => {
        const row = tbody.insertRow();
        const statusBadge = getStatusBadge(report.status);
        
        row.innerHTML = `
            <td>${report.report_id}</td>
            <td>${formatDate(report.test_date)}</td>
            <td>${report.first_name} ${report.last_name}</td>
            <td>${report.phone_number}</td>
            <td>${report.doctor_name || 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewReport(${report.report_id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="downloadReportPDF(${report.report_id})" title="Download PDF">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="createBill(${report.report_id})" title="Create Bill">
                        <i class="fas fa-file-invoice"></i>
                    </button>
                </div>
            </td>
        `;
    });
}

function getStatusBadge(status) {
    const statusMap = {
        'pending': 'bg-warning',
        'in_progress': 'bg-info',
        'completed': 'bg-success'
    };
    return `<span class="badge ${statusMap[status] || 'bg-secondary'}">${status.replace('_', ' ').toUpperCase()}</span>`;
}

function filterReports() {
    const searchTerm = document.getElementById('searchReports').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    const rows = document.querySelectorAll('#reportsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.cells[5].textContent.toLowerCase();
        const date = row.cells[1].textContent;
        
        let show = true;
        
        if (searchTerm && !text.includes(searchTerm)) {
            show = false;
        }
        
        if (statusFilter && !status.includes(statusFilter)) {
            show = false;
        }
        
        if (dateFilter && !date.includes(dateFilter)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('searchReports').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    filterReports();
}

function saveReport() {
    const form = document.getElementById('addReportForm');
    const formData = new FormData(form);
    
    // Get selected tests
    const selectedTests = [];
    document.querySelectorAll('#testSelection input[type="checkbox"]:checked').forEach(checkbox => {
        selectedTests.push(parseInt(checkbox.value));
    });
    
    const reportData = {
        patient_id: parseInt(formData.get('patient_id')),
        test_date: formData.get('test_date'),
        doctor_name: formData.get('doctor_name'),
        lab_technician: formData.get('lab_technician'),
        notes: formData.get('notes'),
        test_types: selectedTests
    };
    
    showLoading();
    fetch('/api/reports', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reportData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Report created successfully', 'success');
            document.getElementById('addReportForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('addReportModal')).hide();
            loadReports();
        } else {
            showToast('Error creating report: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('Error creating report', 'error');
    });
}

function viewReport(reportId) {
    currentReportId = reportId;
    showLoading();
    
    fetch(`/api/reports/${reportId}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                displayReportDetails(data.data);
                new bootstrap.Modal(document.getElementById('viewReportModal')).show();
            } else {
                showToast('Error loading report details: ' + data.error, 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Error loading report details', 'error');
        });
}

function displayReportDetails(report) {
    const container = document.getElementById('reportDetails');
    
    let testResultsHtml = '';
    if (report.test_results && report.test_results.length > 0) {
        testResultsHtml = `
            <h6>Test Results</h6>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Result</th>
                            <th>Normal Range</th>
                            <th>Status</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.test_results.map(result => `
                            <tr>
                                <td>${result.test_name} (${result.test_code})</td>
                                <td>${result.result_value || 'Pending'} ${result.unit || ''}</td>
                                <td>${result.normal_range || 'N/A'}</td>
                                <td>
                                    <span class="badge ${result.is_normal === true ? 'bg-success' : result.is_normal === false ? 'bg-danger' : 'bg-warning'}">
                                        ${result.is_normal === true ? 'Normal' : result.is_normal === false ? 'Abnormal' : 'Pending'}
                                    </span>
                                </td>
                                <td>${result.remarks || 'None'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        testResultsHtml = '<p class="text-muted">No test results added yet.</p>';
    }
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Report Information</h6>
                <p><strong>Report ID:</strong> ${report.report_id}</p>
                <p><strong>Test Date:</strong> ${formatDate(report.test_date)}</p>
                <p><strong>Status:</strong> ${getStatusBadge(report.status)}</p>
                <p><strong>Doctor:</strong> ${report.doctor_name || 'N/A'}</p>
                <p><strong>Lab Technician:</strong> ${report.lab_technician || 'N/A'}</p>
                <p><strong>Notes:</strong> ${report.notes || 'None'}</p>
            </div>
            <div class="col-md-6">
                <h6>Patient Information</h6>
                <p><strong>Name:</strong> ${report.first_name} ${report.last_name}</p>
                <p><strong>Phone:</strong> ${report.phone_number}</p>
                <p><strong>Date of Birth:</strong> ${report.date_of_birth || 'N/A'}</p>
                <p><strong>Gender:</strong> ${report.gender || 'N/A'}</p>
                <p><strong>Address:</strong> ${report.address || 'N/A'}</p>
            </div>
        </div>
        <hr>
        ${testResultsHtml}
    `;
}

function downloadReportPDF(reportId = null) {
    const id = reportId || currentReportId;
    if (id) {
        window.open(`/api/reports/${id}/pdf`, '_blank');
    }
}

function createBill(reportId) {
    showLoading();
    fetch('/api/bills', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ report_id: reportId })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Bill created successfully', 'success');
        } else {
            showToast('Error creating bill: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('Error creating bill', 'error');
    });
}

function addTestResults() {
    if (!currentReportId) return;
    
    // Load test results form
    fetch(`/api/reports/${currentReportId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.test_results) {
                generateTestResultsForm(data.data.test_results);
                new bootstrap.Modal(document.getElementById('addResultsModal')).show();
            }
        })
        .catch(error => console.error('Error:', error));
}

function generateTestResultsForm(testResults) {
    const container = document.getElementById('testResultsForm');
    container.innerHTML = '';
    
    testResults.forEach(test => {
        const div = document.createElement('div');
        div.className = 'mb-4 p-3 border rounded';
        div.innerHTML = `
            <h6>${test.test_name} (${test.test_code})</h6>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Result Value</label>
                    <input type="text" class="form-control" name="result_${test.test_result_id}" 
                           value="${test.result_value || ''}" placeholder="Enter result">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Normal Range</label>
                    <input type="text" class="form-control" value="${test.normal_range || ''}" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status_${test.test_result_id}">
                        <option value="">Pending</option>
                        <option value="1" ${test.is_normal === true ? 'selected' : ''}>Normal</option>
                        <option value="0" ${test.is_normal === false ? 'selected' : ''}>Abnormal</option>
                    </select>
                </div>
            </div>
            <div class="mt-2">
                <label class="form-label">Remarks</label>
                <textarea class="form-control" name="remarks_${test.test_result_id}" rows="2">${test.remarks || ''}</textarea>
            </div>
        `;
        container.appendChild(div);
    });
}

function saveTestResults() {
    const form = document.getElementById('addResultsForm');
    const formData = new FormData(form);
    
    const results = [];
    const inputs = form.querySelectorAll('input, select, textarea');
    
    const resultData = {};
    inputs.forEach(input => {
        const match = input.name.match(/^(result|status|remarks)_(\d+)$/);
        if (match) {
            const [, field, id] = match;
            if (!resultData[id]) resultData[id] = { test_result_id: parseInt(id) };
            
            if (field === 'result') {
                resultData[id].result_value = input.value;
            } else if (field === 'status') {
                resultData[id].is_normal = input.value === '' ? null : input.value === '1';
            } else if (field === 'remarks') {
                resultData[id].remarks = input.value;
            }
        }
    });
    
    Object.values(resultData).forEach(result => results.push(result));
    
    showLoading();
    fetch(`/api/reports/${currentReportId}/results`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ results })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast('Test results saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addResultsModal')).hide();
            viewReport(currentReportId); // Refresh the report view
            loadReports(); // Refresh the table
        } else {
            showToast('Error saving results: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('Error saving results', 'error');
    });
}
</script>
{% endblock %} 